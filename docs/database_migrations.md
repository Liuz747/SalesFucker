# 数据库迁移指南

本文档详细说明 MAS 项目的数据库迁移系统，包括 Alembic 配置、团队协作工作流程和最佳实践。

## 📋 概述

MAS 项目使用 **Alembic** 作为数据库迁移工具，提供版本化的数据库 schema 管理。系统支持：

- ✅ **版本化迁移** - 每个 schema 更改都有独立的迁移文件
- ✅ **自动生成** - 基于模型更改自动生成迁移代码
- ✅ **回滚支持** - 支持数据库 schema 回滚到之前版本
- ✅ **团队协作** - 迁移文件随代码一起版本控制
- ✅ **异步支持** - 完全支持 PostgreSQL 异步操作

## 🏗️ 系统架构

### 迁移文件结构

```
migrations/
├── alembic.ini           # Alembic 配置文件
├── env.py               # 环境配置（异步 PostgreSQL 连接）
├── script.py.mako       # 迁移文件模板
└── versions/            # 迁移文件目录
    └── 001_initial_tenant_tables.py  # 现有迁移文件
```

### 核心组件

**`scripts/database.py`** - 迁移脚本
- `upgrade()` - 应用迁移到数据库
- `revision(message)` - 生成新的迁移文件

**`migrations/env.py`** - 环境配置
- 异步 PostgreSQL 连接管理
- 自动读取环境变量中的数据库配置
- 模型元数据自动发现

**`models/base.py`** - 基础模型
- `DeclarativeBase` 自动提供 `metadata`
- 所有模型继承自 `Base` 并自动注册

## 🚀 基本用法

### 运行迁移（应用 Schema 更改）

```bash
# 应用所有待执行的迁移
python scripts/database.py

# 如果数据库已是最新版本，输出：
# INFO: Current revision matches head, no migrations to apply
```

### 生成新迁移（添加模型后）

```bash
# 生成带自定义消息的迁移
python scripts/database.py generate "add user table"

# 生成默认消息的迁移
python scripts/database.py generate
```

## 👥 团队协作工作流程

### 场景 1: 添加新模型（模型创建者）

**步骤 1: 创建新模型文件**
```python
# models/user.py
from models.base import Base
from sqlalchemy import Column, String, Integer, Boolean

class UserModel(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    username = Column(String(255), unique=True, nullable=False)
    email = Column(String(255), unique=True, nullable=False)
    is_active = Column(Boolean, default=True)
```

**步骤 2: 生成迁移文件**
```bash
python scripts/database.py generate "add user table"
```

这会创建类似以下的迁移文件：
```python
# migrations/versions/002_add_user_table.py
def upgrade() -> None:
    op.create_table('users',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('username', sa.String(255), unique=True, nullable=False),
        sa.Column('email', sa.String(255), unique=True, nullable=False),
        sa.Column('is_active', sa.Boolean(), default=True),
    )

def downgrade() -> None:
    op.drop_table('users')
```

**步骤 3: 提交代码**
```bash
git add models/user.py migrations/versions/002_add_user_table.py
git commit -m "Add user model and migration"
git push origin main
```

### 场景 2: 拉取他人更改（其他开发者）

**步骤 1: 拉取最新代码**
```bash
git pull origin main
```

**步骤 2: 应用数据库迁移**
```bash
python scripts/database.py
```

**输出示例：**
```
INFO: 开始数据库迁移...
INFO: Running upgrade  -> 002, add user table
INFO: ✅ 数据库迁移完成
```

## ⚠️ 重要注意事项

### 何时运行 `upgrade`

**✅ 需要运行的情况：**
- 初次设置项目环境
- `git pull` 后发现有新的迁移文件
- 部署到生产环境前
- 切换到包含新迁移的分支后

**❌ 不需要运行的情况：**
- 每日启动开发环境
- 没有新的迁移文件时
- 只是修改代码逻辑（不涉及数据库 schema）

### 何时运行 `revision`

**✅ 需要运行的情况：**
- 添加新的模型类
- 修改现有模型（添加/删除/修改字段）
- 添加新的索引或约束
- 修改表结构

**❌ 不需要运行的情况：**
- 拉取他人的迁移文件后
- 只修改业务逻辑代码
- 迁移文件已存在时

### 空迁移文件处理

如果运行 `revision` 时数据库与模型已同步，会生成空的迁移文件：

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
```

**处理方式：**
- 可以安全删除空迁移文件
- 或保留作为"检查点"标记

## 🔧 配置详解

### Alembic 配置 (`migrations/alembic.ini`)

```ini
[alembic]
script_location = migrations
prepend_sys_path = .
```

### 环境配置 (`migrations/env.py`)

**关键特性：**
- 自动读取 `settings.postgres_url` 环境变量
- 支持异步 PostgreSQL 连接
- 自动发现所有继承自 `Base` 的模型
- 优雅的连接管理和清理

### 数据库连接

**环境变量配置：**
```env
# .env 文件
DB_HOST=your-database-host
DB_PORT=5432
DB_NAME=mas
POSTGRES_USER=postgres
POSTGRES_PWD=your-password
```

**连接字符串自动生成：**
```python
# config/settings.py
postgres_url = f"postgresql+asyncpg://{POSTGRES_USER}:{POSTGRES_PWD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"
```

## 🛠️ 常见问题与解决方案

### 问题 1: 迁移文件冲突

**场景：** 多人同时添加模型，产生相同版本号的迁移文件

**解决方案：**
```bash
# 合并代码后重新生成迁移
git pull origin main
python scripts/database.py generate "merge conflicts resolution"
```

### 问题 2: 数据库连接失败

**症状：** `数据库连接失败` 错误

**检查清单：**
1. 确认 `.env` 文件配置正确
2. 确认数据库服务正在运行
3. 检查网络连接和防火墙设置
4. 验证数据库用户权限

### 问题 3: 模型更改未被检测

**原因：** 模型文件未正确导入到 `Base.metadata`

**解决方案：**
1. 确保模型继承自 `models.base.Base`
2. 检查 `migrations/env.py` 中的导入配置
3. 重新生成迁移文件

## 🎯 最佳实践

### 1. 迁移文件命名

```bash
# 描述性命名
python scripts/database.py generate "add user authentication"
python scripts/database.py generate "add product catalog tables"
python scripts/database.py generate "update customer profile schema"
```

### 2. 模型设计原则

```python
# 良好的模型设计
class UserModel(Base):
    __tablename__ = "users"
    
    # 使用适当的字段长度
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = Column(String(255), unique=True, nullable=False, index=True)
    
    # 添加创建和更新时间戳
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
    
    # 使用明确的索引
    __table_args__ = (
        Index('idx_user_username', 'username'),
        Index('idx_user_created', 'created_at'),
    )
```

### 3. 生产部署流程

```bash
# 生产环境迁移
git pull origin main
python scripts/database.py  # 应用迁移
python main.py            # 启动应用
```

## 📚 相关文档

- [Alembic 官方文档](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 异步支持](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [项目 README.md](../README.md) - 快速开始指南

---

> **提示**: 数据库迁移是确保团队数据一致性的关键工具。遵循本指南的工作流程，可以避免常见的数据库同步问题，确保开发和生产环境的稳定性。